---
title: "Premiers pas en WebScraping"
subtitle: "Introduction à la collecte automatique de données du Web"
date: "`r Sys.Date()`"
author: 
 - name: Léa Christophe
   affiliation: Université Paris 1 Panthéon-Sorbonne, UMR Géographie-cités
 - name: Hugues Pecout
   affiliation: CNRS, UMR Géographie-cités
image: "featured.png"   
logo: "figures/rzine.png"  
output:
  rzine::readrzine:
    highlight: kate
    number_sections: true
csl: Rzine_citation.csl
bibliography: biblio.bib
nocite: |
  @*
link-citations: true
# github: "author/repository"
# gitlab: "gitlab.huma-num.fr/author/repository"
# doi: "xx.xxx/xxxx.xxxxxxx"
# licence: "by-sa"

# Only Creative Commons Licence 
# 5 possible choices : "by-nd", "by", "by-nc-sa", "by-nc","by-sa"
---

```{r setup, include=FALSE}

## Global options
knitr::opts_chunk$set(echo=TRUE,
        	            cache=FALSE,
                      prompt=FALSE,
                      comment=NA,
                      message=FALSE,
                      warning=FALSE,
                      class.source="bg-info",
                      class.output="bg-warning")


```


> Cet article peut être utilisé pour une initiation aux bases de la collecte automatique de données du Web avec R. De nombreux aspects et méthodes de webscraping qui ne sont pas abordés dans ce document sont présenté sur ce [**site web associé**](https://webscraping.gitpages.huma-num.fr/website/) plus complet et approfondie sur le webscraping avec R et Python. 

# Introduction {-}

Le *web scraping*, ou extraction de données sur le web, est une technique qui consiste à extraire de manière automatisée des informations à partir de sites web. En d'autres termes, c'est comme si vous utilisiez un robot pour récupérer des données à partir de pages web, plutôt que de le faire manuellement.

En sciences humaines et sociales, le *web scraping* peut être utilisé pour collecter des données pertinentes sur des sites web, forums, blogs, des réseaux sociaux, ou autres sources en ligne. Cette méthode peut être particulièrement utile pour analyser des tendances, des opinions, des dynamiques... ou tout simplement pour constituer une base de données à partir de plusieurs sources web. L'utilisation de R pour le web scraping permet d'automatiser ces processus et d'analyser les données extraites de manière efficace.

Le *Web scraping* permet d'extraire des informations spécifiques d'une page web en analysant sa structure HTML et en extrayant uniquement les éléments pertinents. Cette pratique demande ainsi quelques connaissances techniques en matière de web, de langague de balisage HTML et de le CSS, qui permettent respectivement de structurer une page web et de définir l'apparence et la mise en forme des différents éléments du document.

Au delà de présenter le web scraping avec R, cet article aborde dans un premier temps les connaisances indispensables à la mise en place d'une collecte de données automatisée.

Le *Web scraping* regroupe différentes techniques plus ou moins complexes. Cet article, qui est une inititation à la pratique de la collecte automatique de données présente le cas d'utilisation le plus simple. Pour aller plus loin et se former à des techniques plus avancées, vous pouvez consulter ce support de formation plus détaillé : https://webscraping.gitpages.huma-num.fr/website/




# Bases techniques

L’extraction automatisé de données du web requiert des prérequis indispensables : certaines connaissances spécifiques liées à la structure d’une page web et une compréhension des principes techniques sous-jacents. Vous devez ainsi acquérir une connaissance du langage HTML (balises) et une familiarité avec le CSS (sélecteurs) pour identifier, cibler et extraire les éléments d’une page web.

## Le langage HTML

Le HTML, acronyme de HyperText Markup Language (langage de balisage hypertexte en français), est un langage informatique utilisé pour structurer et organiser le contenu des pages web.Il utilise une syntaxe basée sur des balises (tags) pour délimiter les différents éléments d’une page. 

### Les balises

Il n'y a pas de nombre fixe de balises HTML, car de nouvelles balises peuvent être introduites avec les versions futures du langage HTML. Cependant, il existe un ensemble de balises HTML standard définies dans les spécifications du W3C (*World Wide Web Consortium*^[Le World Wide Web Consortium, abrégé par le sigle W3C, est un organisme de standardisation à but non lucratif, fondé en octobre 1994 chargé de promouvoir la compatibilité des technologies du World Wide Web telles que HTML5, HTML, XHTML, XML, RDF, SPARQL, CSS, XSL, PNG, SVG, MathML et SOAP.]). Pour obtenir la liste la plus à jour des balises HTML, vous pouvez consulter la documentation officielle du W3C.

Chaque balise est entourée des symboles `<` et `>` et peut contenir des attributs qui spécifient des propriétés supplémentaires pour l’élément. Si aucune balise n'est obligatoire dans une page HTML, il est de convention d'avoir la structure de base suivante :

``` {html, eval = FALSE, class.source='bg-info'}
<!DOCTYPE html>
<html>
<head>
    <title>Titre de la page</title>
</head>
<body>

    <!-- Contenu de la page -->
    
</body>
</html>
```

- `<!DOCTYPE html>` : En début du document, indique au navigateur qu’il s’agit d’une page HTML5^[HTML5 (HyperText Markup Language 5) est la dernière révision majeure du HTML (format de données conçu pour représenter les pages web). Cette version a été finalisée le 28 octobre 2014. HTML5 spécifie deux syntaxes d'un modèle abstrait défini en termes de DOM : HTML5 et XHTML5.].
- `<html>` : Englobe tout le contenu de la page HTML.
- `<head>` : Contient les métadonnées de la page, des liens vers des fichiers annexes (CSS, javascript…), etc.
- `<title>` : Pour définir le titre de la page qui apparaîtra dans la barre de titre du navigateur.
- `<body>` : Contient tout le contenu visible de la page, tel que le texte, les images, les liens, les tableaux, etc.


Dans la majorité des cas, on utilise une balise de fermeture pour indiquer la fin de l'élémént. Une balise de fermeture présente un `/` avant le nom de la balise :

``` {html, eval = FALSE, class.source='bg-info'}
<body>

    <!-- Contenu de la page -->
    
</body>
```


Le body peut contenir toute une variété de balises prédéfinies pour structurer et ajouter différents types de contenu dans la page web. Voici quelques balises indispensables à connaitre :

- `<html>` : Définit le début et la fin du document HTML.
- `<head>` : Contient les métadonnées du document.
- `<title>` : Définit le titre du document.
- `<body>` : Contient le contenu principal du document.
- `<h1>`, `<h2>`, …, `<h6>` : Définissent les titres de différents niveaux.
- `<p>` : Définit un paragraphe.
- `<a>` : Crée un lien hypertexte.
- `<img>` : Insère une image.
- `<ul>`, `<ol>`, `<li>` : Créent des listes non ordonnées et ordonnées.
- `<table>`, `<tr>`, `<td>` : balises pour créer des tableaux avec des lignes et des cellules de données.
- `<div>` : Divise le document en sections ou en groupes de contenu.
- `<span>` : Applique des styles à des parties de texte.


Exemple de balise `p` (paragraphe) :

``` {html, eval = FALSE, class.source='bg-info'}
<body>

<p>Un paragraphe en langage HTML</p>

</body>
```

Dans cet exemple, la balise `<p>` représente un paragraphe dont le contenu "Un paragraphe en langage HTML" est placé entre la balise d'ouverture `<p>` et la balise de fermeture `</p>`.


### Les attributs

Ces balises hiérarchisées et potentiellement regroupées, peuvent être accompagnées d'attributs qui permettent de spécifier des informations supplémentaires et jouer sur leur mise en forme, tels que des identifiants (`id`), des classes (`class`), des liens (`href`), etc. Ces attributs sont à spécifier dans la balise d'ouverture :

``` {html, eval = FALSE, class.source='bg-info'}
<body>

<div id="debut_doc">
    <h1 class="categorie">Tous les articles</h1>
</div>

<div id="Liste_ref">
    <h2 class="article">Titre article</h2>
    <p class="summary">Résumé de l'article...</p>
    <a href="https://www.article.org">Intégralité de l'article</a>
</div>

</body>
```

L'organisation segmenté du contenu via les balises `div` ou `span` ainsi que les différents attributs spécifiés permettent la mise en forme et le paramétrage des éléments. Mais la structure de la page ainsi que **les attributs spécifiés sont également des éléments cruciaux pour la collecte automatisée de données sur le web**.

Les attributs des balises peuvent être associée à une mise en forme (couleur, taille, position, etc.) à l'aide du langage CSS.

\

## La langage CSS

Le CSS, ou *Cascading Style Sheets* (feuilles de style en cascade), est un langage de programmation utilisé pour décrire l’apparence et la mise en forme des documents HTML et XML. Il permet de contrôler l’apparence visuelle des différents éléments de pages web (taille, position, couleur, police, marges, etc.) via les sélecteurs CSS.

Le CSS peut être incorporé de différentes manières :

**1. Dans les balises** à l'aide de l'attribut `style` :

``` {html, eval = FALSE, class.source='bg-info'}
<h1 style ="font-size:40px;color:#f03b35;text-align:center;">Titre principal</h1>
```

**2. Dans le document HTML**, via la balise `<style>` adaptée à cet effet :

``` {html, eval = FALSE, class.source='bg-info'}
<style>

h1 {
color: #f03b35;
font-size: 40px;
text-align: center;
}
    
</style>

<body>
<h1>Titre principal</h1>
</body>
```


**3. Dans une feuille de style externe** (fichier texte avec l'extension `.css`). Cette dernière méthode est à privilégier car la séparation du contenu et la mise en forme facilite la mise à jour des styles :

:::: {style="display: flex;"}

::: {.column width="59%"}
<center><b>page.html</b></center>

``` {html, eval = FALSE, class.source='bg-info'}
<body>

<h1>Titre principal</h1>

</body>
```
:::

::: {.column width="2%"}
:::

::: {.column width="39%"}
<center><b>style.css</b></center>

```{r, eval = FALSE, class.source='bg-warning'}

h1 { 
color: #f03b35;
font-size: 40px;
text-align:center;
}

```
:::
::::

À chaque fois, le rendu graphique sera le suivant :

![](figures/h1.png){fig-align="center"}



### Les sélecteurs CSS simples


<div class="alert alert-danger">**Bien qu'une connaissance approfondie du CSS ne soit pas nécessaire le scraping, il est important de connaître les sélecteurs CSS.** **Leur utilisation est précieuse pour cibler des données de manière détaillée et ainsi optimiser la collecte.**</div>

Plusieurs sélecteurs CSS permettent de cibler et styliser les différentes balises HTML :


**1. Les sélecteurs d’éléments** : permet de cibler tous les éléments d’un même type.

:::: {style="display: flex;"}
::: {.column width="49%"}
``` {html, eval = FALSE, class.source='bg-info'}
<h2>Titre de niveau 2</h2>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
h2 { font-size: 20px; }
```
:::
::::

\

**2. Les sélecteurs d'identifiants** : permet de cibler un élément spécifique par son identifiant (`**id**`).

:::: {style="display: flex;"}
::: {.column width="49%"}
```{html, eval = FALSE, class.source='bg-info'}
<div id="example">  </div>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
#example { background-color: #f2f2f2; }
```
:::
::::

\

**3. Les sélecteurs de classes** : permet de cibler les éléments ayant une classe spécifique (`**class**`).

:::: {style="display: flex;"}
::: {.column width="49%"}
``` {html, eval = FALSE, class.source='bg-info'}
<p class="summary">Ceci est un résumé</p>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
.summary { font-family: Arial, sans-serif; }
```
:::
::::

\

**4. Les sélecteurs d'attributs** : cible les éléments ayant un attribut spécifique. Exemple : l'attribut `href` (lien cliquable)\

:::: {style="display: flex;"}
::: {.column width="49%"}
``` {html, eval = FALSE, class.source='bg-info'}
<a href="https://www.example.org">Lien</a>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
a[href] { color: purple; }
```
:::
::::

Il est possible de préciser sa cible en indiquant une valeur pour l'attribut.

::: {.column width="50%"}
```{css, eval = FALSE, class.source='bg-warning'}
a[href="https://example.org"] { color: purple;}
```
:::

\

### Les sélecteurs complexes et combinateurs

Le CSS met également à disposition des sélecteurs complexes et combinateurs que l'on peut utiliser pour cibler des contenus de manière très précise. Quelques exemples :

**A. Les sélecteurs descendants** : cible les éléments qui sont descendants d'un autre élément.

:::: {style="display: flex;"}
::: {.column width="49%"}
``` {html, eval = FALSE, class.source='bg-info'}
<div id="liste_ref">

  
    <p class="summary">Ceci est un résumé</p>
    
  
</div>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
#liste_ref p .summary { font-size: 12px; }
```
<div class="alert alert-danger">Cible tous les paragraphes de la classe `summary`, positionnés dans l'élément ayant pour identifiant `liste_ref`.</div>
:::
::::


\

**B. Les sélecteurs de voisin direct** : cible les nœuds qui suivent immédiatement un élément

:::: {style="display: flex;"}
::: {.column width="49%"}
``` {html, eval = FALSE, class.source='bg-info'}
<div id="liste_ref">

    <h2>Titre de l'article</h2>
    <p class="summary">Ceci est un résumé</p>
    
    <h2>Titre de l'article</h2>
    <p class="summary">Ceci est un résumé</p>
        
</div>
```
:::

::: {.column width="2%"}
:::

::: {.column width="49%"}
```{css, eval = FALSE, class.source='bg-warning'}
#liste_ref + h2 { font-size: 14px; }
```

\

<div class="alert alert-danger">Cible uniquement la première balise `h2` de l'élément ayant pour identifiant `liste_ref`.</div>
:::
::::



\

## Le code source d'une page web

La connaissance du HTML et du CSS vous permettra de comprendre et de naviguer dans le code source du page web. L’ensemble des navigateurs web modernes proposent des outils d’inspection du code source des pages web. 

**L’inspecteur de code source** permet d’explorer le code source d’une page web en direct. Il **permet l’identification des balises, des classes, des identifiants et des styles associés aux éléments, et ainsi de procéder à une extraction ciblée de données**. En utilisant l’inspecteur de code source, vous accédez à toutes les informations nécessaires pour concevoir un script de scraping. 


Pour y accéder, cliquez-droit n’importe où sur la page web ciblée, puis cliquez sur “Inspecter” :

:::: {style="display: flex;"}
::: {.column width="49%"}
::: {style="text-align: center;"}
Avec *Google Chrome* :


![](figures/inspector_html_chrome.png){fig-align="center"}
::: 
::: 
::: {.column width="2%"}
:::

::: {.column width="49%"}
::: {style="text-align: center;"}
Avec *Mozilla FireFox* :

![](figures/inspector_html.png)
:::
::: 
::::

\

L'inspecteur s'ouvre et en utilisant l'outil de sélection (entouré en <font style="color:#FF0000;">**rouge**</font>), il donne la possibilité de naviguer dans le code source en survolant les différents éléments de la page, et vice versa.

![](figures/inspecteur_capture2.png)

\

Vous pouvez déplier le code source pour l'explorer en profondeur. Cet article est une page HTML dans laquelle l'ensemble de la partie "2. Bases techniques" semblent contenu dans une `div` ayant pour identifiant "bases-techniques" :

![](figures/code_inspect.png)




<div class="alert alert-danger">Pour cette page, le sélecteur `#bases-techniques h2` permet ainsi de cibler tous les titres de niveau 2 présents dans l'élément `div` ayant pour identifiant "bases-techniques"... Le scraping peut commencer !</div>


**Ajoutez une partie + image sur la copie du Xpath/selecteur CSS...**

\


# Présentation du cas pratique

Présentation du site web exemple utilisé sur des biens immobiliers (fictifs) à vendre à Paris. dans le style https://books.toscrape.com/, avec au moins les variables suivantes :

- Une illustration
- titre accrocheur façon agance (ex : bien d'exception, maison de maître...)
- Le type : appart, maison ou local commercial
- Le prix
- La surface
- Le nb de pièces
- Une description du bien (caricaturale, comme ça on peut faire un nuage de mot rigolo)
- Une adresse (non fictive, comme cela on peut gécoder et cartographier
- Et plus si affintés !



## Exporation manuelle -présentation du code 

(captures écran)


# Mise en pratique

Définir ses objectifs ! = Présentation du système d'URL

lecture de chaque page de chaque bien
Objectifs de ce scraping ?

## Récupération des URLs des biens de la première page

## Boucler sur toutes les pages pour récuperer toutes les URL à scraper

## exemple de scrap sur la première page (sans boucle)

### 1 élément text

### 1 image

### Tous les élements ciblés

## Pareil mais boucle sur toutes les pages


## Présentation de la BD scrapée

### Répartition par type

### Distribution par type/prix

### Surface moyenne

### Nuage de mot sur les description des biens


### Carte !

Géocodage adresse + carto 

### Export

#### csv

#### Géopackage

# Conclusion

Ouverture Le bon coin ?








 





## Données collectées

## Collecte page ressource

boucle dur URL pré collectées

récupération de toutes les metadonnées + section thématique

## Données collectées - explo

explo par section thématique


# Pour aller plus loin

## Rselenium

## Support complet


# Bibliographie {-}

<div id="refs"></div>

# Annexes {-}

## Info session  {-}

```{r session_info, echo=FALSE}
kableExtra::kable_styling(knitr::kable(rzine::sessionRzine()[[1]], row.names = F))
kableExtra::kable_styling(knitr::kable(rzine::sessionRzine()[[2]], row.names = F))
```

## Citation {-}

```{r Citation, echo=FALSE}
rref <- bibentry(
   bibtype = "misc",
   title = "Titre de la fiche",
   subtitle = "Sous-Titre de la fiche",
   author = c("Premier Auteur.e", "Second Auteur.e"),
   doi = "10.48645/xxxxxx",
   url = "https://rzine.fr/publication_rzine/xxxxxxx/",
   keywords ="FOS: Other social sciences",
   language = "fr",
   publisher = "FR2007 CIST",
   year = 2021,
   copyright = "Creative Commons Attribution Share Alike 4.0 International")

``` 

`r capture.output(print(rref))`

### BibTex : {-}

```{r generateBibTex, echo=FALSE}

writeLines(toBibtex(rref), "cite.bib")
toBibtex(rref)

``` 

<br/>

## Glossaire {- #endnotes}

```{js, echo=FALSE}

$(document).ready(function() {
  $('.footnotes ol').appendTo('#endnotes');
  $('.footnotes').remove();
});

```
